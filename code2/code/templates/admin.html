<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chat Proxy – 관리자 페이지</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #f8fafc; --panel: #ffffff; --muted: #f1f5f9; --ring: #e2e8f0;
            --text: #1e293b; --sub: #64748b;
            --blue: #2563eb; --blue-2: #60a5fa; --mint: #10b981;
            --danger: #ef4444; --success: #16a34a; --warn: #f59e0b;
            --shadow: 0 4px 12px rgba(30, 41, 59, .06);
            --radius: 12px; --radius-sm: 8px;
        }
        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            margin: 0; color: var(--text); background: var(--bg);
            font: 500 15px/1.55 "Pretendard", "Inter", "Noto Sans KR", system-ui;
            -webkit-font-smoothing: antialiased;
        }
        .layout { display: grid; grid-template-columns: 260px 1fr; height: 100vh; }
        .sidebar { background: var(--panel); border-right: 1px solid var(--ring); padding: 16px; display: flex; flex-direction: column; }
        .brand { display: flex; align-items: center; gap: 10px; margin-bottom: 24px; }
        .logo { width: 32px; height: 32px; border-radius: 10px; background: conic-gradient(from 180deg, var(--blue), var(--mint), var(--blue)); box-shadow: 0 0 0 4px rgba(59, 130, 246, .12); }
        .brand h1 { font-size: 18px; margin: 0; }
        .nav-group-title { font-size: 12px; color: #94a3b8; margin: 20px 8px 8px; }
        .nav-link { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: var(--radius-sm); text-decoration: none; color: var(--sub); border: 1px solid transparent; transition: all .2s; cursor: pointer; }
        .nav-link:hover { background: var(--muted); color: var(--text); }
        .nav-link.active { background: #eef2ff; color: var(--blue); font-weight: 600; border-color: #c7d2fe; }
        .sidebar footer { margin-top: auto; font-size: 12px; color: #94a3b8; padding: 16px 0; border-top: 1px solid var(--ring); }
        .sidebar footer a { color: var(--blue); cursor: pointer; }
        .main { display: grid; grid-template-rows: auto 1fr; height: 100vh; overflow: hidden; }
        .topbar { display: flex; align-items: center; padding: 14px 24px; background: var(--panel); border-bottom: 1px solid var(--ring); }
        .topbar h2 { margin: 0; font-size: 20px; }
        .content-wrap { overflow-y: auto; padding: 24px; }
        .card { background: var(--panel); border-radius: var(--radius); border: 1px solid var(--ring); box-shadow: var(--shadow); padding: 20px; }
        .btn { padding: 10px 16px; border-radius: var(--radius-sm); border: 1px solid var(--ring); background: var(--panel); color: var(--text); cursor: pointer; font-weight: 600; box-shadow: var(--shadow); transition: all .2s; }
        .btn:hover { border-color: #94a3b8; }
        .btn.primary { background: var(--blue); color: #fff; border-color: var(--blue); }
        .btn.primary:hover { background: #1d4ed8; }
        .btn.danger { background: var(--danger); color: #fff; border-color: var(--danger); }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 14px; text-align: left; border-bottom: 1px solid var(--ring); font-size: 14px; vertical-align: middle; }
        th { background: var(--muted); color: var(--sub); font-weight: 600; }
        td code { background: var(--muted); padding: 2px 6px; border-radius: 4px; font-size: 13px; }
        tbody tr:hover { background: #fcfdff; }
        .tag { display: inline-block; padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 600; }
        .tag.mask { background: #ffedd5; color: #9a3412; }
        .tag.block { background: #fee2e2; color: #991b1b; }
        .tag.user { background: #e0e7ff; color: #3730a3; }
        .tag.admin { background: #dcfce7; color: #15803d; }
        .input { flex: 1; border: 1px solid var(--ring); background: #fff; padding: 10px 12px; border-radius: var(--radius-sm); outline-color: var(--blue); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .stat-card { background: var(--panel); border-radius: var(--radius); border: 1px solid var(--ring); padding: 20px; box-shadow: var(--shadow); }
        .stat-card .label { font-size: 14px; color: var(--sub); margin-bottom: 8px; }
        .stat-card .value { font-size: 32px; font-weight: 700; }
        .chart-card { margin-top: 24px; }
        .chart-wrapper { position: relative; height: 350px; width: 100%; }
        .modal-backdrop { position: fixed; inset: 0; background: rgba(30, 41, 59, .6); display: none; place-items: center; backdrop-filter: blur(4px); z-index: 100; }
        .modal-content { background: var(--panel); padding: 24px; border-radius: var(--radius); width: 100%; max-width: 500px; box-shadow: 0 20px 50px rgba(0,0,0,.2); }
        .modal-content h3 { margin: 0 0 20px; }
        .form-field { margin-bottom: 16px; }
        .form-field label { display: block; font-size: 13px; margin-bottom: 6px; }
        .form-field .input, .form-field select { width: 100%; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 24px; }
    </style>
</head>
<body>
    <div class="layout">
        <aside class="sidebar">
            <div class="brand"><div class="logo"></div><h1>Admin</h1></div>
            <nav>
                <a class="nav-link" data-view="dashboard">📊 대시보드</a>
                <a class="nav-link" data-view="logs">🛡️ 감사 로그</a>
                <div class="nav-group-title">관리</div>
                <a class="nav-link" data-view="users">👥 사용자 관리</a>
                <a class="nav-link" data-view="rules">⚙️ 탐지 규칙 관리</a>
                <a class="nav-link" data-view="status">🌐 시스템 상태</a>
            </nav>
            <footer>Chat Proxy Capstone. <br/><a onclick="localStorage.clear(); location.href='/';">로그아웃</a></footer>
        </aside>

        <main class="main">
            <div class="topbar"><h2 id="view-title"></h2></div>
            <div class="content-wrap">
                <section id="dashboard-view">
                    <div class="stats-grid">
                        <div class="stat-card"><div class="label">총 요청</div><div class="value" id="stat-today-requests">0</div></div>
                        <div class="stat-card"><div class="label">탐지된 민감정보</div><div class="value" id="stat-pii-detected">0</div></div>
                        <div class="stat-card"><div class="label">차단된 요청</div><div class="value" id="stat-blocked">0</div></div>
                        <div class="stat-card"><div class="label">활성 사용자</div><div class="value" id="stat-active-users">0</div></div>
                    </div>
                    <div class="chart-card card">
                        <h3>최근 7일 요청/탐지 추이</h3>
                        <div class="chart-wrapper"><canvas id="trends-chart"></canvas></div>
                    </div>
                    <div class="chart-card card">
                        <h3>탐지 유형 분포</h3>
                        <div class="chart-wrapper"><canvas id="pii-chart"></canvas></div>
                    </div>
                </section>

                <section id="logs-view" style="display: none;"><div class="card"><table><thead><tr><th>시간</th><th>사용자</th><th>탐지 내역</th><th>처리</th><th>요청 내용</th></tr></thead><tbody id="log-table-body"></tbody></table></div></section>
                <section id="users-view" style="display: none;"><div class="card"><button class="btn primary" id="add-user-btn" style="margin-bottom: 20px;">＋ 새 사용자 추가</button><table><thead><tr><th>사용자 ID (이메일)</th><th>역할</th><th>마지막 접속</th><th>관리</th></tr></thead><tbody id="user-table-body"></tbody></table></div></section>
                <section id="rules-view" style="display: none;"><div class="card"><button class="btn primary" id="add-rule-btn" style="margin-bottom: 20px;">＋ 새 규칙 추가</button><table><thead><tr><th>규칙 이름</th><th>처리 방식</th><th>정규식 (Regex)</th><th>활성 상태</th><th>관리</th></tr></thead><tbody id="rule-table-body"></tbody></table></div></section>
                <section id="status-view" style="display: none;"><div class="card"><p>시스템 상태 보기 페이지는 아직 구현되지 않았습니다.</p></div></section>
            </div>
        </main>
    </div>

    <div class="modal-backdrop" id="user-modal"><div class="modal-content"><h3 id="user-modal-title">새 사용자 추가</h3><form id="user-form"><input type="hidden" id="user-id-hidden"><div class="form-field"><label for="user-email">사용자 ID (이메일)</label><input type="email" id="user-email" class="input" required></div><div class="form-field"><label for="user-password">비밀번호</label><input type="password" id="user-password" class="input"></div><div class="form-field"><label for="user-role">역할</label><select id="user-role" class="input"><option value="user">User</option><option value="admin">Admin</option></select></div><div class="modal-actions"><button type="button" class="btn" id="user-modal-close">취소</button><button type="submit" class="btn primary">저장</button></div></form></div></div>

    <div class="modal-backdrop" id="rule-modal"><div class="modal-content"><h3 id="rule-modal-title">새 규칙 추가</h3><form id="rule-form" novalidate><input type="hidden" id="rule-id-hidden"><div class="form-field" style="background: #f7f9fc; padding: 12px; border-radius: 8px; border: 1px dashed var(--ring);"><label for="rule-ai-description" style="font-weight: 600;">AI로 정규식 생성</label><div style="display: flex; gap: 8px; margin-top: 8px;"><input type="text" id="rule-ai-description" class="input" placeholder="예: 010으로 시작하는 휴대폰 번호"><button type="button" class="btn" id="generate-regex-btn">생성</button></div></div><div class="form-field"><label for="rule-name">규칙 이름</label><input type="text" id="rule-name" class="input" required placeholder="예: 주민등록번호"></div><div class="form-field"><label for="rule-action">처리 방식</label><select id="rule-action" class="input"><option value="mask">마스킹 (Mask)</option><option value="block">차단 (Block)</option></select></div><div class="form-field"><label for="rule-regex">정규식 (Regex)</label><input type="text" id="rule-regex" class="input" required placeholder="AI로 생성하거나 직접 입력하세요"></div><div class="form-field"><label for="rule-status">상태</label><select id="rule-status" class="input"><option value="active">활성</option><option value="inactive">비활성</option></select></div><div class="modal-actions"><button type="button" class="btn" id="rule-modal-close">취소</button><button type="submit" class="btn primary">저장</button></div></form></div></div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_BASE = '/api/admin';

        const viewTitle = document.getElementById('view-title');
        const views = document.querySelectorAll('main .content-wrap > section');
        const navLinks = document.querySelectorAll('.nav-link');
        
        const logTableBody = document.getElementById('log-table-body');
        const userTableBody = document.getElementById('user-table-body');
        const ruleTableBody = document.getElementById('rule-table-body');

        const userForm = document.getElementById('user-form'), userModal = document.getElementById('user-modal');
        const ruleForm = document.getElementById('rule-form'), ruleModal = document.getElementById('rule-modal');
        
        let trendsChartInstance = null;
        let piiChartInstance = null;

        const showView = (viewId) => {
            views.forEach(view => view.style.display = 'none');
            const activeView = document.getElementById(`${viewId}-view`);
            if (activeView) activeView.style.display = 'block';

            navLinks.forEach(link => link.classList.toggle('active', link.dataset.view === viewId));

            const linkText = document.querySelector(`.nav-link[data-view="${viewId}"]`).textContent;
            viewTitle.textContent = linkText.substring(2);

            if (viewId === 'logs') fetchLogs();
            else if (viewId === 'users') fetchUsersAndRender();
            else if (viewId === 'rules') fetchRulesAndRender();
            else if (viewId === 'dashboard') updateDashboardData();
        };
        
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => { e.preventDefault(); showView(link.dataset.view); });
        });

        const fetchDashboardStats = async () => {
            try {
                const response = await fetch(`${API_BASE}/dashboard-stats`);
                if (!response.ok) return;
                const stats = await response.json();
                document.getElementById('stat-today-requests').textContent = stats.today_requests.toLocaleString();
                document.getElementById('stat-pii-detected').textContent = stats.pii_detected.toLocaleString();
                document.getElementById('stat-blocked').textContent = stats.blocked.toLocaleString();
                document.getElementById('stat-active-users').textContent = stats.active_users.toLocaleString();
            } catch (error) { console.error("Dashboard stats error:", error); }
        };

        const renderTrendsChart = async () => {
            try {
                const response = await fetch(`${API_BASE}/trends`);
                if (!response.ok) return;
                const trendsData = await response.json();
                const trendsCtx = document.getElementById('trends-chart').getContext('2d');
                if (trendsChartInstance) trendsChartInstance.destroy();
                trendsChartInstance = new Chart(trendsCtx, { type: 'line', data: trendsData, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } });
            } catch (error) { console.error("Trends chart error:", error); }
        };
        
        const renderPiiChart = async () => {
            try {
                const response = await fetch(`${API_BASE}/distribution`);
                if (!response.ok) return;
                const piiData = await response.json();
                const piiCtx = document.getElementById('pii-chart').getContext('2d');
                if (piiChartInstance) piiChartInstance.destroy();
                piiChartInstance = new Chart(piiCtx, { type: 'pie', data: piiData, options: { responsive: true, maintainAspectRatio: false } });
            } catch (error) { console.error("PII chart error:", error); }
        };
        
        const updateDashboardData = () => {
            fetchDashboardStats();
            renderTrendsChart();
            renderPiiChart();
        };

        const fetchLogs = async () => {
            try {
                const response = await fetch(`${API_BASE}/logs`);
                if (!response.ok) throw new Error('로그를 불러오는 데 실패했습니다.');
                const logs = await response.json();
                renderLogs(logs);
            } catch (error) {
                console.error(error);
                logTableBody.innerHTML = `<tr><td colspan="5" style="color:var(--danger);">${error.message}</td></tr>`;
            }
        };
        
        const renderLogs = (logs) => {
             logTableBody.innerHTML = '';
             logs.forEach(log => {
                 const tr = document.createElement('tr');
                 tr.innerHTML = `
                    <td>${new Date(log.ts).toLocaleString('ko-KR')}</td>
                    <td>${log.user || 'N/A'}</td>
                    <td>${log.pii.join(', ') || '-'}</td>
                    <td><span class="tag ${log.action.toLowerCase()}">${log.action.toUpperCase()}</span></td>
                    <td>${(log.user_prompt || '').substring(0, 30)}...</td>
                 `;
                 logTableBody.appendChild(tr);
             });
        };

        const fetchUsersAndRender = async () => {
            try {
                const response = await fetch(`${API_BASE}/users`);
                if (!response.ok) throw new Error('사용자 목록을 불러오는 데 실패했습니다.');
                renderUsers(await response.json());
            } catch (error) {
                console.error(error);
                userTableBody.innerHTML = `<tr><td colspan="4" style="color:var(--danger);">${error.message}</td></tr>`;
            }
        };

        const renderUsers = (users) => {
            userTableBody.innerHTML = '';
            users.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.id}</td>
                    <td><span class="tag ${user.role}">${user.role.toUpperCase()}</span></td>
                    <td>(구현 예정)</td>
                    <td>
                        <button class="btn btn-sm" onclick="editUser('${user.id}')">수정</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}')">삭제</button>
                    </td>
                `;
                userTableBody.appendChild(tr);
            });
        };

        window.deleteUser = async (userId) => {
            if (userId === 'admin@company.com') return alert('기본 관리자 계정은 삭제할 수 없습니다.');
            if (!confirm(`정말로 사용자 '${userId}'를 삭제하시겠습니까?`)) return;
            try {
                const response = await fetch(`${API_BASE}/users/${userId}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('사용자 삭제에 실패했습니다.');
                fetchUsersAndRender();
            } catch (error) { console.error(error); alert(error.message); }
        };
        window.editUser = (userId) => alert(`'${userId}' 사용자 수정 기능은 아직 구현되지 않았습니다.`);
        
        document.getElementById('add-user-btn').addEventListener('click', () => { userForm.reset(); document.getElementById('user-modal-title').textContent = '새 사용자 추가'; userModal.style.display = 'grid'; });
        document.getElementById('user-modal-close').addEventListener('click', () => { userModal.style.display = 'none'; });
        userForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userData = { id: document.getElementById('user-email').value, password: document.getElementById('user-password').value, role: document.getElementById('user-role').value };
            if (!userData.password) return alert('새 사용자를 추가할 때는 비밀번호가 필수입니다.');
            try {
                const response = await fetch(`${API_BASE}/users`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(userData) });
                if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error || '사용자 추가에 실패했습니다.'); }
                userModal.style.display = 'none';
                fetchUsersAndRender();
            } catch (error) { console.error(error); alert(error.message); }
        });

        const fetchRulesAndRender = async () => {
            try {
                const response = await fetch(`${API_BASE}/rules`);
                if (!response.ok) throw new Error('규칙을 불러오는 데 실패했습니다.');
                renderRules(await response.json());
            } catch (error) {
                console.error(error);
                ruleTableBody.innerHTML = `<tr><td colspan="5" style="color:var(--danger);">${error.message}</td></tr>`;
            }
        };

        const renderRules = (rules) => {
            ruleTableBody.innerHTML = '';
            rules.forEach(rule => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${rule.name}</td>
                    <td><span class="tag ${rule.action}">${rule.action.toUpperCase()}</span></td>
                    <td><code>${rule.regex}</code></td>
                    <td>${rule.is_active ? '✅ 활성' : '❌ 비활성'}</td>
                    <td>
                        <button class="btn btn-sm" onclick="editRule(${rule.id})">수정</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteRule(${rule.id}, '${rule.name}')">삭제</button>
                    </td>
                `;
                ruleTableBody.appendChild(tr);
            });
        };
        
        window.deleteRule = async (ruleId, ruleName) => {
            if (!confirm(`정말로 '${ruleName}' 규칙을 삭제하시겠습니까?`)) return;
            try {
                const response = await fetch(`${API_BASE}/rules/${ruleId}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('규칙 삭제에 실패했습니다.');
                fetchRulesAndRender();
            } catch (error) { console.error(error); alert(error.message); }
        };
        window.editRule = (ruleId) => alert(`'ID: ${ruleId}' 규칙 수정 기능은 아직 구현되지 않았습니다.`);
        
        document.getElementById('add-rule-btn').addEventListener('click', () => { ruleForm.reset(); document.getElementById('rule-modal-title').textContent = '새 규칙 추가'; ruleModal.style.display = 'grid'; });
        document.getElementById('rule-modal-close').addEventListener('click', () => { ruleModal.style.display = 'none'; });
        ruleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const ruleData = { name: document.getElementById('rule-name').value, regex: document.getElementById('rule-regex').value, action: document.getElementById('rule-action').value, is_active: document.getElementById('rule-status').value === 'active' };
            try {
                const response = await fetch(`${API_BASE}/rules`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(ruleData) });
                if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error || '규칙 추가에 실패했습니다.'); }
                ruleModal.style.display = 'none';
                fetchRulesAndRender();
            } catch (error) { console.error(error); alert(error.message); }
        });
        
        document.getElementById('generate-regex-btn').addEventListener('click', async () => {
            const description = document.getElementById('rule-ai-description').value.trim();
            if (!description) return alert('정규식으로 만들 설명을 입력해주세요.');
            const btn = document.getElementById('generate-regex-btn');
            const originalBtnText = btn.textContent;
            btn.textContent = '생성 중...';
            btn.disabled = true;
            try {
                const response = await fetch(`${API_BASE}/rules/generate-regex`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ description }) });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || '정규식 생성에 실패했습니다.');
                document.getElementById('rule-regex').value = data.regex;
            } catch (error) {
                console.error('Regex generation error:', error);
                alert(`오류: ${error.message}`);
            } finally {
                btn.textContent = originalBtnText;
                btn.disabled = false;
            }
        });

        const init = () => {
            showView('dashboard');
            setInterval(updateDashboardData, 10000); 
        };
        
        init();
    });
</script>
</body>
</html>